function out = plot3_99_99percentiles(D,lThres,sevDist)

D = D(D>=lThres);
  
   
%Preparing for the density plot in the area subplot(2,2,1)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% N = length(D);  
A = sort(D);
% B = [1:N]'/N-1/N;
B = linspace(1/length(D),1-1/length(D),length(D));
adj=cdf(sevDist,lThres);
B1=(cdf(sevDist,A)- adj)/(1-adj);

        if strcmpi(sevDist.DistributionName, 'Gamma')
        adj=cdf(sevDist,log(lThres));
        B1=(cdf(sevDist,log(A))- adj)/(1-adj);
        name_d='Loggamma';
        else 
        adj=cdf(sevDist,lThres);
        B1=(cdf(sevDist,A)- adj)/(1-adj);
        name_d=sevDist.DistributionName;
        end
   
%         if strcmpi(sevDist.DistributionName, 'Gamma')
%         
%         end
       
    

 %subplot(2,2,4) for the log-log tail plot
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
subplot(2,2,1);
plot(B,B1);
hold on
plot(B,B,'r');
title(['Q-Q Plot  ',num2str(name_d), '']);
legend('empirical','theoretical',2);

ylabel('CDF');
xlabel('Quantile');
hold off

subplot(2,2,2);
loglog(A,1-B,'.',A,1-B1,'r','LineWidth',1);
title(['Log-log Tail Plot  ',num2str(name_d), '']);
% combinedStr = strcat('Empirical Data with Threshold ',num2str(T),' for UOM ',num2str(U));
legend('empirical','theoretical',3);
xlabel('Dollars');
ylabel('1 - CDF');
hold off


%%

  D = D(D>=lThres);

 name_d=sevDist.DistributionName;
 
if strcmpi(sevDist.DistributionName, 'Gamma')
truncated = truncate(sevDist,log(lThres),Inf);
else
truncated = truncate(sevDist,lThres,Inf);
end

% quantile(1:100, [0,1])

quantiles1 = linspace(0,1,501);
quantiles2 = linspace(1/length(D),1-1/length(D),501);

X = quantile(D,quantiles1);
Y = icdf(truncated, quantiles2);

if strcmpi(sevDist.DistributionName, 'Gamma')
  Y = exp(Y);
  name_d='Loggamma';
end
    
subplot(2,2,3);
loglog([X(1), X(end)],[X(1), X(end)], 'g--','LineWidth',1);
hold on
loglog(X,Y,'LineWidth',2)
title({['QQ Plot  ',num2str(name_d)], 'Theoretical/Fitted Max at 100*(1-1/N)%ile'});

xlabel('Observed');
ylabel('Fitted');
hold off









%%

  D = D(D>=lThres);

 name_d=sevDist.DistributionName;
 
if strcmpi(sevDist.DistributionName, 'Gamma')
truncated = truncate(sevDist,log(lThres),Inf);
else
truncated = truncate(sevDist,lThres,Inf);
end

% quantile(1:100, [0,1])

quantiles1 = linspace(0,1,501);
quantiles2 = linspace(0,.999,501);

X = quantile(D,quantiles1);
Y = icdf(truncated, quantiles2);



if strcmpi(sevDist.DistributionName, 'Gamma')
  Y = exp(Y);
  name_d='Loggamma';
end
    
subplot(2,2,4);
loglog([X(1), X(end)],[X(1), X(end)], 'g--','LineWidth',1);
hold on

t1 = quantile(D,.5)   ;  loglog(repmat(t1,1,2),[X(1), t1], 'm:','LineWidth',1);
t1 = quantile(D,.9)   ;  loglog(repmat(t1,1,2),[X(1), t1], 'm:','LineWidth',1);
t1 = quantile(D,.95)  ;  loglog(repmat(t1,1,2),[X(1), t1], 'm:','LineWidth',1);


loglog(X,Y,'LineWidth',2)
title({['QQ Plot  ',num2str(name_d)], 'Theoretical/Fitted Max at 99.9%ile'});
xlabel({'Observed: Vertical lines at','percentiles 50, 90, and 95'});
ylabel('Fitted');
hold off

out = [quantiles1' , X', quantiles2', Y'];
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
